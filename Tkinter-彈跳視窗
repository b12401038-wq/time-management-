'''
ç›®å‰å®ƒå¯ä»¥åšåˆ°è®“ä½¿ç”¨è€…è‡ªå·±è¼¸å…¥ä»»å‹™åç¨±ã€æé†’æ™‚é–“ä»¥åŠå»¶å¾Œæ™‚é–“è¦å¤šä¹…
ç„¶å¾Œå¯ä»¥è¼¸å…¥å¾ˆå¤šå€‹ä»»å‹™(ç›´åˆ°è¼¸å…¥'n'ç‚ºæ­¢)
é‚„æœ‰å€‹å°bugå°±æ˜¯å½ˆè·³è¦–çª—è¦åœ¨è¼¸å…¥'n'çµæŸè¼¸å…¥ä¹‹å¾Œæ‰æœƒå‡ºç¾

ç•¶æŒ‰ä¸‹é–‹å§‹ã€å»¶å¾Œæˆ–æ˜¯å®Œæˆéƒ½æœƒå†è·³å‡ºå°æ‡‰å°è¦–çª—
(ä¸éæˆ‘å…¶å¯¦ä¸å¤ªçŸ¥é“ä»»å‹™é–‹å§‹éµæ„ç¾©ï¼Œä½†ç›®å‰æƒ³ä¸åˆ°æ‡‰è©²æŠŠå®ƒæ”¹æˆä»€éº¼ï¼Œç­‰æ˜å¤©ä¸€èµ·è¨è«–å¾Œæˆ‘å†çœ‹è¦å¦‚ä½•å¢æ¸›)
åº•ä¸‹ç¨‹å¼æˆ‘æŠŠè¨»è§£ä¹Ÿç•™è‘—(ä¸ç„¶æ€•æˆ‘ä¹‹å¾Œçœ‹ä¸æ‡‚...)
///æˆ‘æ˜¯ç”¨Geminiå¯«çš„!!!Geminiå¤ªå¼·å¤§äº†\\\
'''


import tkinter as tk
from tkinter import messagebox
from datetime import datetime, timedelta
import time
import threading

# --- æ•¸æ“šçµæ§‹ï¼šç”¨å­—å…¸å„²å­˜å–®å€‹ä»»å‹™çš„è³‡è¨Š ---
# æ¯å€‹ä»»å‹™éƒ½æœƒè¢«å„²å­˜ç‚ºä¸€å€‹å­—å…¸ï¼Œä¾‹å¦‚ï¼š
# {'title': 'å–æ°´', 'target_time': <datetime object>, 'snooze_minutes': 10}
TASK_LIST = [] 

def create_reminder_window(task):
    """
    å‰µå»ºä¸¦é¡¯ç¤ºç½®é ‚çš„æé†’è¦–çª—
    
    :param task: è§¸ç™¼æé†’çš„ä»»å‹™å­—å…¸
    """
    root = tk.Tk()
    root.title("æ™‚é–“ç®¡ç†å¤§å¸« - æé†’è¦–çª—")
    root.attributes('-topmost', True)
    
    # è¦–çª—ç½®ä¸­è¨ˆç®—
    window_width = 300
    window_height = 150
    screen_width = root.winfo_screenwidth()
    screen_height = root.winfo_screenheight()
    center_x = int(screen_width/2 - window_width/2)
    center_y = int(screen_height/2 - window_height/2)
    root.geometry(f'{window_width}x{window_height}+{center_x}+{center_y}')
    
    # æé†’æ¨™ç±¤
    tk.Label(
        root, 
        text=f"â° {task['title']}", 
        font=("å¾®è»Ÿæ­£é»‘é«”", 16, "bold"), 
        fg="#293F49",
        pady=10
    ).pack()

    # --- æŒ‰éˆ•å‹•ä½œå®šç¾© ---
    
    def on_start():
        """é»æ“Š 'é–‹å§‹' æŒ‰éˆ•æ™‚çš„å‹•ä½œ"""
        messagebox.showinfo("ä»»å‹™é–‹å§‹!", f"åŠ æ²¹!\nç¥ä½ é †åˆ©å®Œæˆï¼š{task['title']}")
        root.destroy()

    def on_snooze():
        """
        é»æ“Š 'å»¶å¾Œ' æŒ‰éˆ•æ™‚çš„å‹•ä½œ
        æ–°å¢äº†åœ¨å‘½ä»¤åˆ—å°å‡ºæ›´æ–°æ™‚é–“çš„é‚è¼¯
        """
        # è¨ˆç®—æ–°çš„æé†’æ™‚é–“
        current_time = datetime.now()
        new_time = current_time + timedelta(minutes=task['snooze_minutes'])
        
        # æ›´æ–°ä»»å‹™å­—å…¸ä¸­çš„ç›®æ¨™æ™‚é–“
        task['target_time'] = new_time
        
        # 1. è¼¸å‡ºåˆ°å‘½ä»¤åˆ—ï¼šé¡¯ç¤ºä»»å‹™æ™‚é–“å·²æ›´æ–°
        print("-" * 35)
        print(f"ğŸ”„ **æ’ç¨‹æ›´æ–°**ï¼š{task['title']}")
        print(f"   ä¸‹æ¬¡æé†’æ™‚é–“å·²æ›´æ–°ç‚ºï¼š{new_time.strftime('%m/%d %H:%M')}")
        print("-" * 35)

        # 2. å½ˆå‡º Tkinter è¨Šæ¯æ¡†
        messagebox.showinfo(
            "ä»»å‹™å»¶å¾Œ", 
            f"ä»»å‹™ï¼š{task['title']} å·²å»¶å¾Œ {task['snooze_minutes']} åˆ†é˜ã€‚\nä¸‹æ¬¡æé†’æ™‚é–“ï¼š{new_time.hour:02d}:{new_time.minute:02d}"
        )
        root.destroy()

    def on_complete():
        """é»æ“Š 'å®Œæˆ' æŒ‰éˆ•æ™‚çš„å‹•ä½œ"""
        messagebox.showinfo("ä»»å‹™å®Œæˆ", f"{task['title']} å·²å®Œæˆ\nè¾›è‹¦ä½ äº†!ä½ è¶…ç´šæ£’ã€‚")
        root.destroy()
        
        # æ¨™è¨˜ä»»å‹™ç‚ºå®Œæˆ (ç‚ºäº†è®“ç›£æ§ç·šç¨‹åœæ­¢)
        task['completed'] = True

        
    # --- æŒ‰éˆ•ä½ˆå±€ ---
    
    button_frame = tk.Frame(root)
    button_frame.pack(pady=10)

    # é–‹å§‹æŒ‰éˆ•
    tk.Button(
        button_frame, 
        text="é–‹å§‹", 
        command=on_start, 
        font=("å¾®è»Ÿæ­£é»‘é«”", 12), 
        bg="#85c983", 
        fg="#ebebe3"
    ).pack(side=tk.LEFT, padx=5, pady=5)

    # å»¶å¾ŒæŒ‰éˆ•
    tk.Button(
        button_frame, 
        text=f"å»¶å¾Œ ({task['snooze_minutes']}åˆ†)", 
        command=on_snooze, 
        font=("å¾®è»Ÿæ­£é»‘é«”", 12)
    ).pack(side=tk.LEFT, padx=5, pady=5)

    # å®ŒæˆæŒ‰éˆ•
    tk.Button(
        button_frame, 
        text="å®Œæˆ", 
        command=on_complete, 
        font=("å¾®è»Ÿæ­£é»‘é«”", 12), 
        bg="#83Bec9", 
        fg="#ebebe3"
    ).pack(side=tk.LEFT, padx=5, pady=5)
    
    root.mainloop()

def check_time_for_task(task):
    """
    å°ˆé–€ç”¨æ–¼ç›£æ§å–®ä¸€ä»»å‹™æ™‚é–“çš„å‡½å¼ï¼Œæœƒåœ¨ç¨ç«‹çš„åŸ·è¡Œç·’ä¸­é‹è¡Œã€‚
    
    :param task: ä»»å‹™å­—å…¸
    """
    while True:
        # å¦‚æœä»»å‹™è¢«æ¨™è¨˜ç‚ºå®Œæˆï¼Œå‰‡åœæ­¢è©²ç·šç¨‹
        if task.get('completed'):
            print(f"âœ… ä»»å‹™ç·šç¨‹çµæŸ: {task['title']}")
            break

        now = datetime.now()
        target = task['target_time']
        
        # æª¢æŸ¥ç•¶å‰æ™‚é–“æ˜¯å¦åˆ°é”ç›®æ¨™æ™‚é–“ (åªæª¢æŸ¥åˆ°åˆ†é˜)
        if now.hour == target.hour and now.minute == target.minute:
            try:
                # å½ˆå‡ºè¦–çª—ï¼Œä¸¦å°‡ç•¶å‰ä»»å‹™å­—å…¸å‚³å…¥
                create_reminder_window(task)
            except Exception:
                # å¿½ç•¥å› è¦–çª—é—œé–‰è€Œç”¢ç”Ÿçš„éŒ¯èª¤
                pass 
                
            # è¦–çª—å½ˆå‡ºå¾Œï¼Œç­‰å¾…ä¸€åˆ†é˜ï¼Œé˜²æ­¢åŒä¸€åˆ†é˜å…§é‡è¤‡å½ˆå‡º
            time.sleep(60)
            
        else:
            # æ¯ 10 ç§’æª¢æŸ¥ä¸€æ¬¡æ™‚é–“
            time.sleep(10)

def collect_user_tasks():
    """æ”¶é›†ä½¿ç”¨è€…è¼¸å…¥çš„å¤šå€‹ä»»å‹™è³‡è¨Š"""
    
    while True:
        print("-" * 30)
        task_name = input("äº‹ä»¶åç¨±ï¼ˆè¼¸å…¥ 'n' çµæŸè¼¸å…¥ï¼‰ï¼š")
        if task_name.lower() == 'n':
            break

        while True:
            try:
                time_str = input("è«‹è¼¸å…¥æé†’æ™‚é–“ï¼ˆHH:MMï¼Œä¾‹å¦‚ 14:30ï¼‰ï¼š")
                h, m = map(int, time_str.split(':'))
                
                # ç°¡å–®é©—è­‰æ™‚é–“æ ¼å¼
                if not (0 <= h <= 23 and 0 <= m <= 59):
                    raise ValueError("å°æ™‚æˆ–åˆ†é˜ä¸åœ¨æœ‰æ•ˆç¯„åœå…§ã€‚")

                # è¨­å®šç›®æ¨™æ™‚é–“ç‚ºä»Šå¤©æœ€è¿‘çš„é‚£å€‹æ™‚é–“é»
                now = datetime.now()
                target_dt = now.replace(hour=h, minute=m, second=0, microsecond=0)
                
                # å¦‚æœè¨­å®šçš„æ™‚é–“å·²ç¶“éäº†ä»Šå¤©ï¼Œå‰‡å°‡æé†’è¨­å®šç‚ºæ˜å¤©
                if target_dt <= now:
                    target_dt += timedelta(days=1)
                    print(f"å‚™è¨»: {h:02d}:{m:02d} å·²éï¼Œå·²è‡ªå‹•è¨­å®šç‚ºæ˜å¤© {h:02d}:{m:02d}")
                    
                break
            except ValueError as e:
                print(f"è¼¸å…¥éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥æ™‚é–“æ ¼å¼ï¼ˆHH:MMï¼‰ï¼š{e}")

        while True:
            try:
                snooze_min = int(input("è«‹è¼¸å…¥å»¶å¾Œæ™‚é–“ï¼ˆåˆ†é˜ï¼‰ï¼š"))
                break
            except ValueError:
                print("è¼¸å…¥éŒ¯èª¤ï¼Œè«‹è¼¸å…¥æœ‰æ•ˆçš„æ•¸å­—ã€‚")
        
        # å°‡ä»»å‹™è³‡è¨Šå„²å­˜åˆ°åˆ—è¡¨ä¸­
        TASK_LIST.append({
            'title': task_name,
            'target_time': target_dt,
            'snooze_minutes': snooze_min,
            'completed': False # æ–°å¢ç‹€æ…‹æ¨™è¨˜
        })
        print(f"âœ… ä»»å‹™å·²æ–°å¢ã€‚ä¸‹æ¬¡æé†’æ™‚é–“ï¼š{target_dt.strftime('%H:%M')}ã€‚")


# --- ä¸»ç¨‹å¼åŸ·è¡Œå€ ---
if __name__ == "__main__":
    
    # 1. æ”¶é›†æ‰€æœ‰ä»»å‹™
    collect_user_tasks()

    if not TASK_LIST:
        print("æœªè¨­å®šä»»ä½•ä»»å‹™ï¼Œç¨‹å¼çµæŸã€‚")
    else:
        print("\n" + "=" * 40)
        print("    æ™‚é–“ç®¡ç†å¤§å¸« - ä»»å‹™è¦åŠƒã€å‘Šåˆ¥æ‹–å»¶    ")
        print("=" * 40)
        print("è«‹å‹¿é—œé–‰æ­¤å‘½ä»¤åˆ—è¦–çª—ï¼Œå®ƒè² è²¬èƒŒæ™¯è¨ˆæ™‚ã€‚")
        print("å·²å•Ÿå‹•ä»»å‹™ï¼š")
        
        # 2. ç‚ºæ¯å€‹ä»»å‹™å•Ÿå‹•ä¸€å€‹ç¨ç«‹çš„åŸ·è¡Œç·’
        for task in TASK_LIST:
            # è¼¸å‡ºä»»å‹™è³‡è¨Š
            print(f"- {task['title']}ï¼Œä¸‹æ¬¡æé†’æ™‚é–“ï¼š{task['target_time'].strftime('%m/%d %H:%M')}")
            
            # å•Ÿå‹•ç¨ç«‹ç·šç¨‹
            thread = threading.Thread(target=check_time_for_task, args=(task,))
            thread.daemon = True # è¨­å®šç‚ºå®ˆè­·ç·šç¨‹ï¼Œä¸»ç¨‹å¼çµæŸæ™‚å®ƒä¹ŸæœƒçµæŸ
            thread.start()
        
        print("\næ‰€æœ‰ä»»å‹™ç·šç¨‹å·²åœ¨èƒŒæ™¯é‹è¡Œ...")

        # 3. ä¿æŒä¸»ç·šç¨‹å­˜æ´»ï¼Œä»¥ä¾¿è®“èƒŒæ™¯ç·šç¨‹é‹è¡Œ
        try:
            while True:
                time.sleep(1)
        except KeyboardInterrupt:
            print("\nğŸš¨ æé†’ç¨‹å¼å·²æ‰‹å‹•é—œé–‰ã€‚")
